upstream {{ application_name }}_wsgi_server {
    # fail_timeout=0 means we always retry an upstream even if it failed
    # to return a good HTTP response (in case the Unicorn master nukes a
    # single worker for timing out).

    server unix:{{ virtualenv_path }}/run/gunicorn.sock fail_timeout=0;
}

server {
    listen 80;
    server_name {{ nginx_server_name_webator_re }};

    client_max_body_size 2M;

    access_log {{ nginx_access_log_file }};
    error_log {{ nginx_error_log_file }};

    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $http_host;
        proxy_redirect off;

        proxy_pass http://{{ application_name }}_wsgi_server;
    }
}


server {
    listen 80;
    server_name {{ nginx_server_name_servator_re }};

    root {{ serve_directory }}$subdomain;

    gzip  on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml application/x-javascript text/javascript text/css text/json;
    gzip_comp_level  6;

    location / {
        try_files index.html index.htm @tree;
    }

    location @tree {
        autoindex on;
    }
}